<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DES Demo</title>
    <style>
        :root { --gap: 12px; --accent: #0077ff; }
        * { box-sizing: border-box; font-family: Arial, sans-serif; }

        body {
          margin: 0;
          padding: var(--gap);
          background: #fafafa;
        }

        header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: #f0f0f0;
          padding: var(--gap) 18px;
          box-shadow: 0 2px 4px rgba(0,0,0,.07);
        }

        .auth-links a {
          margin-left: 18px;
          text-decoration: none;
          color: var(--accent);
        }

        .wrap {
          max-width: 560px;
          margin: 48px auto;
          padding: var(--gap) 24px;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,.08);
        }

        label {
          display: block;
          font-weight: bold;
          margin-top: var(--gap);
        }

        input, select, button {
          width: 100%;
          padding: 10px;
          margin-top: 6px;
          font-size: 1em;
        }

        button {
          cursor: pointer;
          border: none;
          border-radius: 4px;
          background: var(--accent);
          color: #fff;
          font-weight: bold;
          transition: background 0.2s ease;
        }

        button:disabled {
          background: #b0c7ff;
          cursor: not-allowed;
        }

        .actions {
          display: flex;
          gap: var(--gap);
          margin-top: var(--gap);
        }

        .result {
          margin-top: var(--gap);
          word-wrap: break-word;
          white-space: pre-wrap;
        }

        .error {
          color: #c33;
          font-size: 0.9em;
          height: 1.2em;
        }

        .box {
          margin-top: var(--gap);
        }

        h4 {
          margin: var(--gap) 0 6px;
        }

        .round, .key {
          font-family: monospace;
          font-size: 0.9em;
        }
    </style>
</head>
<body>

<header>
    <h2>DES App</h2>
    <nav class="auth-links" id="authLinks" aria-label="Authentication Links"></nav>
</header>

<main class="wrap">
    <h3>Encrypt / Decrypt</h3>

    <label for="mode">Mode</label>
    <select id="mode" aria-label="DES Mode">
        <option value="ECB">ECB</option>
        <option value="CBC">CBC</option>
        <option value="CFB">CFB</option>
        <option value="OFB">OFB</option>
        <option value="CTR">CTR</option>
    </select>

    <label for="message">Plaintext (for encrypt) <br>or Hex ciphertext (for decrypt)</label>
    <input id="message" placeholder="Enter text or hex" aria-describedby="msgErr"/>
    <p class="error" id="msgErr"></p>

    <label for="hexKey">Key (16 hex chars = 64 bits incl. parity)</label>
    <input id="hexKey" placeholder="e.g. 133457799bbcdff1" aria-describedby="keyErr"/>
    <p class="error" id="keyErr"></p>

    <div class="actions">
        <button id="encBtn" onclick="handleEncrypt()">Encrypt</button>
        <button id="decBtn" onclick="handleDecrypt()">Decrypt</button>
    </div>

    <pre class="result" id="result" aria-live="polite"></pre>
    <div class="box" id="roundBox"></div>
    <div class="box" id="keyBox"></div>
</main>

<script>
    const $ = id => document.getElementById(id);
    const API = window.location.origin;

    const isHex = str => /^[0-9a-fA-F]+$/.test(str);
    const clearErrors = () => {
      $("msgErr").textContent = "";
      $("keyErr").textContent = "";
    };

    const disableButtons = disabled => {
      $("encBtn").disabled = $("decBtn").disabled = disabled;
    };

    const writeResult = text => $("result").textContent = text;

    const renderList = (containerId, title, items, className) => {
      const box = $(containerId);
      box.innerHTML = items.length ? `<h4>${title}</h4>` : "";
      items.forEach((item, i) => {
        box.innerHTML += `<div class="${className}">Round ${i + 1}: ${item}</div>`;
      });
    };

    async function fetchDES(endpoint, payload) {
      const response = await fetch(`${API}/${endpoint}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (data.error) throw new Error(data.error);
      return data;
    }

    async function handleEncrypt() {
      clearErrors();
      const message = $("message").value.trim();
      const key = $("hexKey").value.trim().toLowerCase();
      const mode = $("mode").value;

      if (!message) {
        $("msgErr").textContent = "Message required";
        return;
      }
      if (!isHex(key) || key.length !== 16) {
        $("keyErr").textContent = "Key must be 16‑char hex";
        return;
      }

      disableButtons(true);
      try {
        const result = await fetchDES("encrypt", { message, hex_key: key, mode });
        writeResult(`Encrypted (hex):\n${result.encrypted_hex}`);
        renderList("roundBox", "Round Results", result.round_results, "round");
        renderList("keyBox", "Key Expansions", result.key_expansions, "key");
      } catch (e) {
        writeResult(`Error: ${e.message}`);
        renderList("roundBox", "", [], "round");
        renderList("keyBox", "", [], "key");
      } finally {
        disableButtons(false);
      }
    }

    async function handleDecrypt() {
      clearErrors();
      const hexMsg = $("message").value.trim().toLowerCase();
      const key = $("hexKey").value.trim().toLowerCase();
      const mode = $("mode").value;

      if (!hexMsg || !isHex(hexMsg)) {
        $("msgErr").textContent = "Valid hex required";
        return;
      }
      if (!isHex(key) || key.length !== 16) {
        $("keyErr").textContent = "Key must be 16‑char hex";
        return;
      }

      disableButtons(true);
      try {
        const result = await fetchDES("decrypt", { hex_message: hexMsg, hex_key: key, mode });
        writeResult(`Decrypted (utf‑8):\n${result.decrypted_text}\n\nHex:\n${result.decrypted_hex}`);
        renderList("roundBox", "Round Results", result.round_results, "round");
        renderList("keyBox", "Key Expansions", result.key_expansions, "key");
      } catch (e) {
        writeResult(`Error: ${e.message}`);
        renderList("roundBox", "", [], "round");
        renderList("keyBox", "", [], "key");
      } finally {
        disableButtons(false);
      }
    }

    function getCookie(name) {
      return document.cookie
        .split("; ")
        .find(row => row.startsWith(name + "="))
        ?.split("=")[1] || null;
    }

    (function initAuth() {
      const token = getCookie("token");
      const box = $("authLinks");

      if (!token) {
        box.innerHTML = `<a href="/login">Login</a><a href="/register">Register</a>`;
        return;
      }

      try {
        const payload = JSON.parse(atob(token.split(".")[1] || ""));
        const user = payload.sub || "User";
        box.innerHTML = `
          <span>Welcome, ${user}</span>
          <a href="/history">History</a>
          <a href="/logout">Logout</a>
        `;
      } catch {
        box.textContent = "";
      }
    })();
</script>

</body>
</html>
